<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®žçŽ°wordæ ‡æ³¨æ•ˆæžœ</title>
    <style>
        * {
            margin: 0;
            box-sizing: border-box;
        }
        p {
            word-break: break-all;
        }
        dimension {
            position: relative;
            background-color: #ffd5d5;
        }
        .dimension-button {
            position: sticky;
            top: 0;
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #f4f4f4;
            z-index: 1;
        }
        .dimension-side {
            color: #f01201;
        }
        .dimension-side::before {
            position: absolute;
            z-index: 1;
        }
        .dimension-side.start::before {
            content: '{';
            margin-left: -0.1em;
        }
        .dimension-side.end::before {
            content: '}';
            margin-left: -0.2em;
        }
        .dimension-main {
            display: flex;
        }
        .dimension-contain {
            flex: 1;
            padding: 10px;
            font-size: 30px;
        }
        .dimension-text {
            position: relative;
            padding: 0 5px 0 30px;
            width: 240px;
            background-color: #f4f4f4;
        }
        .dimension-lines {
            position: absolute;
            left: 0;
        }
        .dimension-line {
            position: absolute;
            right: 0;
            left: -100px;
            border-bottom: 1px dashed #f01201;
        }
        .dimension-line.active {
            border-bottom-style: solid;
            border-bottom-width: 2px;
        }
        .dimension-list {
            position: relative;
        }
        .dimension-items {
            position: absolute;
            width: 100%;
        }
        .dimension-item {
            /* margin-bottom: 5px; */
            padding: 5px;
            font-size: 12px;
            border-radius: 5px;
            border: 1px solid #f01201;
            background-color: #ffd5d5;
        }
        .dimension-item + .dimension-item {
            margin-top: 1px;
        }
        .dimension-item.active {
            border-width: 2px;
            background-color: #ffa8a8;
        }
        .dimension-label {
            float: left;
        }
        .dimension-input {
            outline: 0;
        }
        #tip-btn {
            color: #f01201;
        }
    </style>
</head>
<body>
    <div class="dimension-button">
        <button id="add-btn">æ ‡æ³¨</button>
        <button id="del-btn">åˆ é™¤</button>
        <span id="tip-btn"></span>
    </div>
    <div class="dimension-main">
        <div class="dimension-contain">
            <div>
                <p>0</p>
                <p>111111</p>
                <p style="font-size: 50px;">2222222222222222<span>S<span>sss</span>BB</span>666666666666666666666</p>
                <p>3333<span>123x</span>33</p>
                <p>444444</p>
                <p>555555</p>
                <p>666666</p>
                <p>777777</p>
                <p>888888</p>
                <p>999999</p>
            </div>
            <div>00000</div>
        </div>
        <div class="dimension-text">
            <!-- <div class="dimension-lines"></div>
            <div class="dimension-list"></div> -->
        </div>
    </div>
    <script type="module">
        import Dimension from './dimension.js'
        const dimension = new Dimension({
            entry: '.dimension-contain',
            output: '.dimension-text',
        })
        document.querySelector('#add-btn').addEventListener('click', () => {
            dimension.add()
        })
        document.querySelector('#del-btn').addEventListener('click', () => {
            dimension.remove()
        })
    </script>
    <script>
        (function (){
            return
            const dimensionName = 'dimension'
            function isValidNode (node) {
                return node.nodeType === Node.TEXT_NODE ? !!node.textContent.replace(/^(\n\s+)?(.*)(\n\s+)?$/, '$2') : true
            }
            function getChildNodes (node, startNode, endNode, list = [], isParent = true) {
                if (!list.includes(endNode)) {
                    for (const node1 of node.childNodes) {
                        if (list.includes(endNode)) break
                        if (isValidNode(node1) && ((!list.length && node1 === startNode) || list.length)) {
                            list.push(node1)
                        }
                        if (list.includes(endNode)) break
                        getChildNodes(node1, startNode, endNode, list, false)
                    }
                    if (isParent) {
                        const nextNode = node.nextSibling
                        nextNode && getChildNodes(nextNode, startNode, endNode, list)
                    }
                }
                return list
            }
            document.querySelector('#add-btn').addEventListener('click', () => {
                const selection = window.getSelection()
                if (!selection.anchorNode) {
                    document.querySelector('#tip-btn').innerText = 'å…ˆæ¡†é€‰ä¸€ä¸‹å˜›ðŸ˜‘'
                    return
                } else {
                    document.querySelector('#tip-btn').innerText = ''
                }
                let { startContainer: startNode, endContainer: endNode, startOffset, endOffset } = selection.getRangeAt(0)
                const contain = document.querySelector('.dimension-contain')
                let elem = startNode
                while (elem.parentElement !== contain) {
                    elem = elem.parentElement
                }
                const list = getChildNodes(elem, startNode, endNode).filter(node => node.nodeType === Node.TEXT_NODE)
                if (startNode.textContent.length === startOffset) {
                    list.shift()
                    startNode = list[0]
                    startOffset = 0
                }
                if (endNode.nodeType !== Node.TEXT_NODE) {
                    endNode = list[list.length - 1]
                    endOffset = endNode.textContent.length
                }
                console.log(list)
                // return
                const key = Date.now()
                let isStart = false
                for (const node of list) {
                    if (!(isStart = isStart || node === startNode)) continue
                    const isEnd = endOffset === 0 || node === endNode
                    if (node.nodeType === Node.TEXT_NODE) {
                        let text = node.textContent
                        if (text) {
                            let startText = ''
                            let endText = ''
                            let dimensionText = text
                            const isStart = node === startNode
                            const isEnd = node === endNode
                            if (isStart && startOffset) {
                                startText = text.substring(0, startOffset)
                                dimensionText = text.substring(startOffset, text.length)
                            }
                            if (isEnd && endOffset < text.length) {
                                endText = text.substring(endOffset)
                                dimensionText = dimensionText.substring(0, dimensionText.length - endText.length)
                            }
                            const parent = node.parentElement
                            if (!startText && !endText && parent.nodeName.toLowerCase() === dimensionName) {
                                parent.setAttribute('key', parent.getAttribute('key') + `,${key}`)
                                isStart && parent.classList.add('dimension-start')
                                if (isEnd) {
                                    parent.classList.add('dimension-end')
                                    setText(parent, key)
                                }
                                continue
                            }
                            if (dimensionText) {
                                const dimension = document.createElement(dimensionName)
                                dimension.innerText = dimensionText
                                dimension.setAttribute('key', key)
                                parent.replaceChild(dimension, node)
                                isStart && dimension.classList.add('dimension-start')
                                if (isEnd) {
                                    dimension.classList.add('dimension-end')
                                    setText(dimension, key)
                                }
                                if (startText) {
                                    parent.insertBefore(document.createTextNode(startText), dimension)
                                }
                                if (endText) {
                                    parent.insertBefore(document.createTextNode(endText), dimension.nextSibling)
                                }
                            }
                        }
                    }
                    if (isEnd) break
                }
                selection.removeAllRanges()
            })
            const data = {
                bottomData: {},
                bottomList: [],
                dimensionTop: 0,
                dimensionMinHeight: 0
            }
            const bottomList = []
            function setText (node, key) {
                window.requestAnimationFrame(() => {
                    console.log(node, node.getBoundingClientRect())
                    const { top, bottom, right } = node.getBoundingClientRect()
                    const item = data[bottom] || { data: {}, right: [] }
                    const lineIndex = data.bottomList.indexOf(bottom)
                    const dimensionLines = document.querySelector('.dimension-lines')
                    const dimensionList = document.querySelector('.dimension-list')
                    const { top: linesTop, left: linesLeft } = dimensionLines.getBoundingClientRect()
                    const left = right - linesLeft
                    const dimensionTop = top - linesTop
                    if (lineIndex < 0) {
                        const dimensionLine = document.createElement('div')
                        dimensionLine.className = 'dimension-line'
                        dimensionLine.dataset.bottom = bottom
                        dimensionLine.style.top = `${bottom - linesTop}px`
                        dimensionLine.style.left = `${left}px`
                        dimensionLines.appendChild(dimensionLine)
                        data.bottomList.push(bottom)
                    } else {
                        const dimensionLine = document.querySelector(`.dimension-line:nth-child(${lineIndex + 1})`)
                        dimensionLine.style.left = `${Math.min(left, parseFloat(dimensionLine.style.left))}px`
                    }
                    const rightList = data.bottomData[bottom] || []
                    let dimensionItems = document.querySelector(`.dimension-items[data-bottom="${bottom}"]`)
                    if (!dimensionItems) {
                        dimensionItems = document.createElement('div')
                        dimensionItems.className = 'dimension-items'
                        dimensionItems.dataset.bottom = bottom
                        dimensionItems.style.top = `${dimensionTop}px`
                        dimensionList.appendChild(dimensionItems)
                    }
                    const dimensionItem = document.createElement('div')
                    dimensionItem.className = 'dimension-item'
                    dimensionItem.dataset.bottom = bottom
                    dimensionItem.dataset.key = key
                    dimensionItem.innerHTML = `<label class="dimension-label">æ ‡æ³¨ï¼š</label>
                        <div class="dimension-input" contenteditable>&nbsp;</div>`
                    dimensionItems.appendChild(dimensionItem)
                })
            }
        })()
    </script>
</body>
</html>