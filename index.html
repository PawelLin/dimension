<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        p {
            word-break: break-all;
        }
        dimension {
            color: red;
        }
    </style>
</head>
<body>
    <div>
        <input id="addInput" type="text">
        <button id="addBtn">添加标注</button>
    </div>
    <p>0</p>
    <p>111111</p>
    <p>2222222222222222<span>S<span>sss</span>BB</span>666666666666666666666</p>
    <p>3333<span>123x</span>33</p>
    <p>444444</p>
    <p>555555</p>
    <p>666666</p>
    <p>777777</p>
    <p>888888</p>
    <p>999999</p>
    <script>
        function getChildNodes (node, list) {
            list = list || [node]
            const childNodes = node.childNodes || []
            childNodes.forEach(node => {
                list.push(node)
                getChildNodes(node, list)
            })
            return list
        }
        const dimensionName = 'dimension'
        const dimensionData = {}
        document.querySelector('#addBtn').addEventListener('click', () => {
            const selection = window.getSelection()
            const { anchorNode, focusNode } = selection
            const startElem = anchorNode.nodeType === Node.TEXT_NODE ? anchorNode.parentElement : anchorNode
            const endElem = focusNode.nodeType === Node.TEXT_NODE ? focusNode.parentElement : focusNode
            const startOffset = selection.anchorOffset
            const endOffset = selection.focusOffset
            const textList = selection.toString().split(/\n+/)
            let isEnd = false
            let elem = anchorNode
            while (elem.parentElement !== document.body) {
                elem = elem.parentElement
            }
            const list = getChildNodes(elem)
            while (!list.includes(focusNode) && list.length < 100) {
                elem = elem.nextSibling
                list.push(elem)
                getChildNodes(elem, list)
            }
            console.log(list)
            console.log('focusNode', focusNode)
            console.log(selection)
            console.log(startOffset, endOffset)
            const key = Date.now()
            if (document.querySelector('input').value === 'no') return
            // return
            let start = false
            for (const node of list) {
                // console.log(!(start = start || node === anchorNode))
                if (!(start = start || node === anchorNode)) continue
                const isEnd = endOffset === 0 || node === focusNode
                if (node.nodeType === Node.TEXT_NODE) {
                    let text = node.textContent.replace(/^(\n\s+)?(.*)(\n\s+)?$/, '$2')
                    console.log(node, text)
                    if (text) {
                        let startText = '', endText = '', dimensionText = text
                        if (node === anchorNode && startOffset) {
                            startText = text.substring(0, startOffset)
                            dimensionText = text.substring(startOffset, text.length)
                        }
                        if (node === focusNode && endOffset < text.length) {
                            endText = text.substring(endOffset)
                            dimensionText = dimensionText.substring(0, dimensionText.length - endText.length)
                        }
                        const parent = node.parentElement
                        if (!startText && !endText && parent.nodeName.toLowerCase() === dimensionName) {
                            parent.setAttribute('key', parent.getAttribute('key') + `,${key}`)
                            return
                        }
                        const dimension = document.createElement(dimensionName)
                        dimension.innerText = dimensionText
                        dimension.setAttribute('key', key)
                        parent.replaceChild(dimension, node)
                        if (startText) {
                            parent.insertBefore(document.createTextNode(startText), dimension)
                        }
                        if (endText) {
                            parent.insertBefore(document.createTextNode(endText), dimension.nextSibling)
                        }
                        console.log(startText, endText, parent)
                    }
                }
                if (isEnd) break
            }
            selection.removeAllRanges()
        })
    </script>
</body>
</html>